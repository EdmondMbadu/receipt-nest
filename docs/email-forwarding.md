# Email Forwarding Ingestion (Low-Cost Setup)

This project now supports receipt ingestion from forwarded emails without creating per-user inboxes.

## Architecture

- Each user gets a readable primary alias generated by `generateReceiptForwardingAddress`.
- Primary alias format: `first.last@<inbound-domain>` (auto-resolved with numeric suffix if needed).
- Fallback alias format: `r-<token>@<inbound-domain>` (always accepted).
- A single public webhook (`inboundEmailWebhook`) receives all inbound mail from your email provider.
- The webhook maps recipient alias token -> user account, then:
  - saves supported attachments (PDF/images) to Storage and creates normal receipt docs (`status: uploaded`)
  - or, if no attachment exists, extracts from email text and creates a generated PNG preview card for gallery thumbnails (`skipProcessing: true`)
- Existing `processReceipt` pipeline handles attachment-based receipts exactly as before.

## Why this is low-cost

- No dedicated mailbox per user.
- One catch-all inbound route for all users.
- Reuses existing Firestore/Storage + extraction pipeline.
- Free-plan cap (200 receipts) is enforced server-side for inbound email as well.

## Required Secrets

Set these Firebase function secrets:

- `RECEIPT_INBOUND_DOMAIN` (example: `inbound.receipt-nest.com`)
- `EMAIL_INGEST_WEBHOOK_KEY` (random strong string; used as query key guard)

## Inbound Provider Setup (SendGrid Inbound Parse)

1. Add and verify your inbound subdomain in SendGrid Inbound Parse.
2. Configure a catch-all route for that subdomain to your function URL:
   - `https://<region>-<project>.cloudfunctions.net/inboundEmailWebhook?key=<EMAIL_INGEST_WEBHOOK_KEY>`
3. Keep `POST` delivery enabled with multipart payloads so attachments are included.

## Supported Attachment Types

- `image/jpeg`, `image/jpg`, `image/png`, `image/webp`, `image/heic`, `image/heif`, `application/pdf`
- Max file size: 10MB per file.

## User Experience

- Home dashboard shows a generated forwarding address and a copy button.
- User forwards receipt emails to that address.
- Receipts appear in the same list and follow the same status flow.

## Troubleshooting

- Check function logs:
  - `inboundEmailWebhook` should log parsed recipients and attachment metadata.
  - `processReceipt` should run for attachment-mode receipts.
- In Firestore receipt docs, inspect `email.ingestMode`:
  - `attachment` means file ingestion path was used.
  - `text_fallback` means no valid attachment was accepted.
    - In this mode, `file.mimeType` is usually `image/png` (generated preview card), and `email.textStoragePath` stores raw extracted email text.
