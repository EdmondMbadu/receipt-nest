<div class="min-h-screen bg-white dark:bg-slate-950">
  <!-- Ambient background -->
  <div class="fixed inset-0 -z-10 overflow-hidden pointer-events-none">
    <div
      class="absolute top-0 left-1/4 w-[600px] h-[600px] rounded-full bg-emerald-500/[0.04] dark:bg-emerald-500/[0.08] blur-[100px]">
    </div>
    <div
      class="absolute bottom-1/4 right-0 w-[400px] h-[400px] rounded-full bg-emerald-400/[0.03] dark:bg-emerald-400/[0.06] blur-[80px]">
    </div>
  </div>

  <!-- Eligible Users: Full AI Insights Experience -->
  @if (hasAiAccess()) {
  <div class="flex flex-col h-screen">
    <!-- Header -->
    <header
      class="flex-shrink-0 border-b border-slate-200 dark:border-slate-800 bg-white/80 dark:bg-slate-950/80 backdrop-blur-xl">
      <div class="mx-auto max-w-4xl px-4 py-4 sm:px-6">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <button type="button" (click)="goBack()"
              class="inline-flex h-10 w-10 items-center justify-center rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 text-slate-500 dark:text-slate-400 shadow-sm transition-all hover:bg-slate-50 dark:hover:bg-slate-800">
              <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
              </svg>
            </button>
            <div>
              <div class="flex items-center gap-2">
                <div
                  class="flex h-8 w-8 items-center justify-center rounded-lg bg-gradient-to-br from-emerald-500 to-teal-600 shadow-xl shadow-emerald-500/25">
                  <svg class="h-4 w-4 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round"
                      d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456z" />
                  </svg>
                </div>
                <h1 class="text-lg font-semibold text-slate-900 dark:text-white">AI Insights</h1>
              </div>
              <p class="text-xs text-slate-500 dark:text-slate-400 mt-0.5">{{ monthLabel() }} · {{ receiptCount() }}
                receipts · {{ formatCurrency(totalSpend()) }}</p>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <!-- Telegram Connect Button -->
            <button type="button" (click)="openTelegramDialog()"
              class="relative inline-flex items-center gap-2 rounded-xl border px-3 py-2 text-xs font-medium shadow-sm transition-all"
              [class.border-sky-300]="telegramLinked()"
              [class.dark:border-sky-600]="telegramLinked()"
              [class.bg-sky-50]="telegramLinked()"
              [class.dark:bg-sky-900/20]="telegramLinked()"
              [class.text-sky-700]="telegramLinked()"
              [class.dark:text-sky-300]="telegramLinked()"
              [class.border-slate-200]="!telegramLinked()"
              [class.dark:border-slate-700]="!telegramLinked()"
              [class.bg-white]="!telegramLinked()"
              [class.dark:bg-slate-900]="!telegramLinked()"
              [class.text-slate-600]="!telegramLinked()"
              [class.dark:text-slate-300]="!telegramLinked()"
              [class.hover:bg-slate-50]="!telegramLinked()"
              [class.dark:hover:bg-slate-800]="!telegramLinked()">
              <!-- Telegram SVG Icon -->
              <svg class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor">
                <path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.479.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/>
              </svg>
              @if (telegramLinked()) {
                Telegram Chat
                <span class="flex h-2 w-2 rounded-full bg-emerald-500"></span>
              } @else {
                Connect Telegram
              }
            </button>
            <button type="button" (click)="clearChat()"
              class="inline-flex items-center gap-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 px-3 py-2 text-xs font-medium text-slate-600 dark:text-slate-300 shadow-sm transition-all hover:bg-slate-50 dark:hover:bg-slate-800">
              <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round"
                  d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
              </svg>
              New chat
            </button>
            <button type="button" (click)="toggleTheme()"
              class="inline-flex h-10 w-10 items-center justify-center rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 text-slate-500 dark:text-slate-400 shadow-sm transition-all hover:bg-slate-50 dark:hover:bg-slate-800">
              @if (isDarkMode()) {
              <svg class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round"
                  d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
              </svg>
              } @else {
              <svg class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round"
                  d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
              </svg>
              }
            </button>
          </div>
        </div>
      </div>
    </header>

    <div class="flex-1 overflow-hidden">
      <div class="mx-auto h-full max-w-5xl px-4 py-4 sm:px-6">
        <section
          class="flex min-h-0 h-full flex-col rounded-2xl border border-slate-200 bg-white/70 shadow-sm backdrop-blur-sm dark:border-slate-800 dark:bg-slate-900/60">
            <div #chatContainer class="min-h-0 flex-1 overflow-y-auto">
              <div class="mx-auto max-w-3xl px-4 py-6 sm:px-6">
                <!-- Initial Insights Cards (shown when no messages) -->
                @if (showSuggestions()) {
                <div class="space-y-6">
                  <!-- Welcome Message -->
                  <div class="text-center py-8">
                    <div
                      class="inline-flex h-16 w-16 items-center justify-center rounded-2xl bg-gradient-to-br from-emerald-500 to-teal-600 shadow-2xl shadow-emerald-500/30 mb-4">
                      <svg class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                        <path stroke-linecap="round" stroke-linejoin="round"
                          d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456z" />
                      </svg>
                    </div>
                    <h2 class="text-2xl font-bold text-slate-900 dark:text-white mb-2">Your Personal Finance AI</h2>
                    <p class="text-sm text-slate-500 dark:text-slate-400 max-w-md mx-auto">
                      I analyze your spending patterns and provide personalized insights to help you save money and make smarter
                      financial decisions.
                    </p>
                  </div>

                  <!-- Quick Insights -->
                  @if (!insightsLoading() && insights().length > 0) {
                  <div class="space-y-3">
                    <div class="flex items-center justify-between">
                      <h3 class="text-sm font-semibold text-slate-700 dark:text-slate-300">Quick Insights for {{ monthLabel() }}
                      </h3>
                      <button type="button" (click)="refreshInsights()"
                        class="inline-flex items-center gap-1 text-xs text-emerald-600 dark:text-emerald-400 hover:text-emerald-700 dark:hover:text-emerald-300 font-medium">
                        <svg class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round"
                            d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
                        </svg>
                        Refresh
                      </button>
                    </div>
                    <div class="grid gap-3">
                      @for (insight of insights(); track insight) {
                      <div
                        class="rounded-2xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 p-4 shadow-sm">
                        <div class="flex items-start gap-3">
                          <div
                            class="flex-shrink-0 flex h-8 w-8 items-center justify-center rounded-lg bg-emerald-100 dark:bg-emerald-900/30">
                            <svg class="h-4 w-4 text-emerald-600 dark:text-emerald-400" fill="none" viewBox="0 0 24 24"
                              stroke="currentColor" stroke-width="2">
                              <path stroke-linecap="round" stroke-linejoin="round"
                                d="M12 18v-5.25m0 0a6.01 6.01 0 001.5-.189m-1.5.189a6.01 6.01 0 01-1.5-.189m3.75 7.478a12.06 12.06 0 01-4.5 0m3.75 2.383a14.406 14.406 0 01-3 0M14.25 18v-.192c0-.983.658-1.823 1.508-2.316a7.5 7.5 0 10-7.517 0c.85.493 1.509 1.333 1.509 2.316V18" />
                            </svg>
                          </div>
                          <p class="text-sm text-slate-700 dark:text-slate-300 leading-relaxed">{{ insight }}</p>
                        </div>
                      </div>
                      }
                    </div>
                  </div>
                  }

                  <!-- Insights Loading -->
                  @if (insightsLoading()) {
                  <div class="space-y-3">
                    @for (_ of [1, 2, 3]; track _) {
                    <div
                      class="rounded-2xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 p-4 animate-pulse">
                      <div class="flex items-start gap-3">
                        <div class="flex-shrink-0 h-8 w-8 rounded-lg bg-slate-200 dark:bg-slate-700"></div>
                        <div class="flex-1 space-y-2">
                          <div class="h-4 bg-slate-200 dark:bg-slate-700 rounded w-full"></div>
                          <div class="h-4 bg-slate-200 dark:bg-slate-700 rounded w-2/3"></div>
                        </div>
                      </div>
                    </div>
                    }
                  </div>
                  }

                  <!-- Suggested Questions -->
                  <div class="space-y-3">
                    <h3 class="text-sm font-semibold text-slate-700 dark:text-slate-300">Ask me anything about your expenses
                    </h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                      @for (question of suggestedQuestions; track question) {
                      <button type="button" (click)="selectSuggestion(question)"
                        class="text-left rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 px-4 py-3 text-sm text-slate-700 dark:text-slate-300 shadow-sm transition-all hover:border-emerald-300 dark:hover:border-emerald-700 hover:bg-emerald-50 dark:hover:bg-emerald-900/20 hover:text-emerald-700 dark:hover:text-emerald-300">
                        {{ question }}
                      </button>
                      }
                    </div>
                  </div>
                </div>
                }

                <!-- Chat Messages -->
                @if (messages().length > 0) {
                <div class="space-y-4">
                  @for (message of messages(); track message.id) {
                  <div class="flex" [class.justify-end]="message.role === 'user'"
                    [class.justify-start]="message.role === 'assistant'">
                    <div class="max-w-[85%] sm:max-w-[75%]">
                      <div class="chat-bubble rounded-2xl px-4 py-3 shadow-sm"
                        [class.chat-bubble--user]="message.role === 'user'"
                        [class.chat-bubble--assistant]="message.role === 'assistant'"
                        [class.text-white]="message.role === 'user'"
                        [class.text-slate-700]="message.role === 'assistant'"
                        [class.dark:text-slate-300]="message.role === 'assistant'">
                        <!-- Receipt image preview (clickable to open full size) -->
                        @if (getThumbnail(message.id); as thumbUrl) {
                          <div class="mb-2">
                            <a [href]="thumbUrl" target="_blank" rel="noopener noreferrer" class="block">
                              <img [src]="thumbUrl" alt="Receipt preview"
                                class="max-w-[200px] rounded-lg border border-white/20 shadow-sm cursor-pointer transition hover:opacity-80 hover:shadow-md" />
                              <span class="text-[10px] opacity-70 mt-1 inline-block">Tap to view full size</span>
                            </a>
                          </div>
                        }
                        <div class="ai-message text-sm leading-relaxed" [innerHTML]="formatMessage(stripReceiptUrl(message.content))"></div>
                      </div>
                      <p class="text-[10px] text-slate-400 mt-1 px-2" [class.text-right]="message.role === 'user'">
                        {{ formatTime(message.timestamp) }}
                      </p>
                    </div>
                  </div>
                  }

                  <!-- Loading indicator -->
                  @if (isLoading()) {
                  <div class="flex justify-start">
                    <div
                      class="rounded-2xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 px-4 py-3 shadow-sm">
                      <div class="flex items-center gap-2">
                        <div class="flex gap-1">
                          <div class="h-2 w-2 rounded-full bg-emerald-500 animate-bounce" style="animation-delay: 0ms;"></div>
                          <div class="h-2 w-2 rounded-full bg-emerald-500 animate-bounce" style="animation-delay: 150ms;"></div>
                          <div class="h-2 w-2 rounded-full bg-emerald-500 animate-bounce" style="animation-delay: 300ms;"></div>
                        </div>
                        <span class="text-xs text-slate-500 dark:text-slate-400">Analyzing your expenses...</span>
                      </div>
                    </div>
                  </div>
                  }
                </div>
                }
              </div>
            </div>

            <div
              class="flex-shrink-0 border-t border-slate-200 dark:border-slate-800 bg-white/60 px-4 py-4 backdrop-blur-xl dark:bg-slate-950/40 sm:px-6">
              <div class="mx-auto max-w-3xl">
                <!-- Upload progress bar -->
                @if (isUploading()) {
                <div class="mb-3 rounded-xl border border-emerald-200 dark:border-emerald-800 bg-emerald-50 dark:bg-emerald-900/20 px-4 py-2.5">
                  <div class="flex items-center gap-3">
                    <div class="h-4 w-4 animate-spin rounded-full border-2 border-emerald-500 border-t-transparent"></div>
                    <span class="text-xs font-medium text-emerald-700 dark:text-emerald-300">Uploading receipt... {{ uploadProgress() }}%</span>
                  </div>
                  <div class="mt-2 h-1.5 w-full rounded-full bg-emerald-200 dark:bg-emerald-800 overflow-hidden">
                    <div class="h-full rounded-full bg-emerald-500 transition-all duration-300" [style.width.%]="uploadProgress()"></div>
                  </div>
                </div>
                }

                <div class="flex items-end gap-2">
                  <!-- Hidden file input -->
                  <input #fileInput type="file" class="hidden"
                    accept="image/jpeg,image/jpg,image/png,image/webp,image/heic,image/heif,application/pdf"
                    (change)="onFileSelected($event)" />

                  <!-- Attach button -->
                  <button type="button" (click)="fileInput.click()"
                    [disabled]="isLoading() || isUploading()"
                    class="inline-flex h-12 w-12 shrink-0 items-center justify-center rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 text-slate-500 dark:text-slate-400 shadow-sm transition-all hover:bg-slate-50 dark:hover:bg-slate-800 hover:text-emerald-600 dark:hover:text-emerald-400 disabled:opacity-50 disabled:cursor-not-allowed"
                    title="Attach receipt (image or PDF)">
                    <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                      <path stroke-linecap="round" stroke-linejoin="round"
                        d="M18.375 12.739l-7.693 7.693a4.5 4.5 0 01-6.364-6.364l10.94-10.94A3 3 0 1119.5 7.372L8.552 18.32m.009-.01l-.01.01m5.699-9.941l-7.81 7.81a1.5 1.5 0 002.112 2.13" />
                    </svg>
                  </button>

                  <div class="relative flex-1">
                    <input #messageInput type="text" [ngModel]="messageText()" (ngModelChange)="messageText.set($event)"
                      (keydown)="onKeyDown($event)" placeholder="Ask about your spending or attach a receipt..."
                      class="w-full rounded-2xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 py-3 pl-4 pr-12 text-sm text-slate-900 dark:text-white placeholder-slate-400 dark:placeholder-slate-500 shadow-sm transition-all focus:border-emerald-500 dark:focus:border-emerald-400 focus:outline-none focus:ring-2 focus:ring-emerald-500/20"
                      [disabled]="isLoading() || isUploading()" />
                  </div>
                  <button type="button" (click)="sendMessage()" [disabled]="isLoading() || isUploading() || !messageText().trim()"
                    class="inline-flex h-12 w-12 shrink-0 items-center justify-center rounded-xl bg-gradient-to-r from-emerald-600 to-teal-600 text-white shadow-lg shadow-emerald-500/25 transition-all hover:shadow-emerald-500/40 hover:scale-[1.02] disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100 disabled:hover:shadow-emerald-500/25">
                    <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round"
                        d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" />
                    </svg>
                  </button>
                </div>
                <p class="text-[10px] text-slate-400 dark:text-slate-500 text-center mt-2">
                  Ask questions or attach receipts (photos, PDFs) to add them to your account.
                </p>
              </div>
            </div>
        </section>
      </div>
    </div>
  </div>
  } @else {
  <!-- Free Users: Upgrade Prompt -->
  <div class="min-h-screen flex items-center justify-center px-4 py-12">
    <div class="max-w-lg w-full text-center">
      <!-- Back button -->
      <button type="button" (click)="goBack()"
        class="absolute top-4 left-4 inline-flex h-10 w-10 items-center justify-center rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 text-slate-500 dark:text-slate-400 shadow-sm transition-all hover:bg-slate-50 dark:hover:bg-slate-800">
        <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
        </svg>
      </button>

      <!-- Lock Icon -->
      <div
        class="mx-auto mb-6 flex h-24 w-24 items-center justify-center rounded-3xl bg-gradient-to-br from-emerald-500/20 to-teal-500/20 dark:from-emerald-500/30 dark:to-teal-500/30 ring-1 ring-emerald-500/20">
        <div
          class="flex h-16 w-16 items-center justify-center rounded-2xl bg-gradient-to-br from-emerald-500 to-teal-600 shadow-xl shadow-emerald-500/30">
          <svg class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M16.5 10.5V6.75a4.5 4.5 0 10-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H6.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z" />
          </svg>
        </div>
      </div>

      <h1 class="text-3xl font-bold text-slate-900 dark:text-white mb-3">Unlock AI Insights</h1>
      <p class="text-slate-500 dark:text-slate-400 mb-8 max-w-sm mx-auto">
        Get personalized financial advice powered by AI. Analyze your spending patterns and discover ways to save money.
      </p>

      <!-- Feature List -->
      <div
        class="rounded-2xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 p-6 mb-8 text-left shadow-lg">
        <h3 class="text-sm font-semibold text-slate-700 dark:text-slate-300 mb-4">Pro Features Include:</h3>
        <ul class="space-y-3">
          <li class="flex items-center gap-3">
            <div class="flex h-6 w-6 items-center justify-center rounded-full bg-emerald-100 dark:bg-emerald-900/30">
              <svg class="h-3.5 w-3.5 text-emerald-600 dark:text-emerald-400" fill="none" viewBox="0 0 24 24"
                stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
              </svg>
            </div>
            <span class="text-sm text-slate-700 dark:text-slate-300">Smart spending analysis & insights</span>
          </li>
          <li class="flex items-center gap-3">
            <div class="flex h-6 w-6 items-center justify-center rounded-full bg-emerald-100 dark:bg-emerald-900/30">
              <svg class="h-3.5 w-3.5 text-emerald-600 dark:text-emerald-400" fill="none" viewBox="0 0 24 24"
                stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
              </svg>
            </div>
            <span class="text-sm text-slate-700 dark:text-slate-300">Personalized savings recommendations</span>
          </li>
          <li class="flex items-center gap-3">
            <div class="flex h-6 w-6 items-center justify-center rounded-full bg-emerald-100 dark:bg-emerald-900/30">
              <svg class="h-3.5 w-3.5 text-emerald-600 dark:text-emerald-400" fill="none" viewBox="0 0 24 24"
                stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
              </svg>
            </div>
            <span class="text-sm text-slate-700 dark:text-slate-300">Ask unlimited questions about your expenses</span>
          </li>
          <li class="flex items-center gap-3">
            <div class="flex h-6 w-6 items-center justify-center rounded-full bg-emerald-100 dark:bg-emerald-900/30">
              <svg class="h-3.5 w-3.5 text-emerald-600 dark:text-emerald-400" fill="none" viewBox="0 0 24 24"
                stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
              </svg>
            </div>
            <span class="text-sm text-slate-700 dark:text-slate-300">Category breakdown & trend analysis</span>
          </li>
          <li class="flex items-center gap-3">
            <div class="flex h-6 w-6 items-center justify-center rounded-full bg-emerald-100 dark:bg-emerald-900/30">
              <svg class="h-3.5 w-3.5 text-emerald-600 dark:text-emerald-400" fill="none" viewBox="0 0 24 24"
                stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
              </svg>
            </div>
            <span class="text-sm text-slate-700 dark:text-slate-300">Budget optimization tips</span>
          </li>
        </ul>
      </div>

      <!-- CTA Button -->
      <button type="button" (click)="goToPricing()"
        class="inline-flex items-center justify-center gap-2 rounded-xl bg-gradient-to-r from-emerald-600 to-teal-600 px-8 py-4 text-base font-semibold text-white shadow-xl shadow-emerald-500/30 transition-all hover:shadow-emerald-500/40 hover:scale-[1.02]">
        <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round"
            d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09z" />
        </svg>
        Upgrade to Pro
      </button>

      <p class="text-xs text-slate-400 dark:text-slate-500 mt-4">
        Starting at just $4.99/month. Cancel anytime.
      </p>
    </div>
  </div>
  }

  <!-- Telegram Link Dialog Modal -->
  @if (telegramDialogOpen()) {
  <div class="fixed inset-0 z-50 flex items-center justify-center px-4">
    <!-- Backdrop -->
    <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" (click)="closeTelegramDialog()"></div>

    <!-- Modal -->
    <div
      class="relative w-full max-w-md rounded-2xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 p-6 shadow-2xl">
      <!-- Close button -->
      <button type="button" (click)="closeTelegramDialog()"
        class="absolute top-4 right-4 inline-flex h-8 w-8 items-center justify-center rounded-lg text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800 transition-all">
        <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>

      @if (telegramLinked()) {
        <!-- Already Linked State -->
        <div class="text-center">
          <div
            class="mx-auto mb-4 flex h-16 w-16 items-center justify-center rounded-2xl bg-emerald-100 dark:bg-emerald-900/30">
            <svg class="h-8 w-8 text-emerald-600 dark:text-emerald-400" fill="none" viewBox="0 0 24 24"
              stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
            </svg>
          </div>
          <h3 class="text-lg font-semibold text-slate-900 dark:text-white mb-2">Telegram Connected</h3>
          <p class="text-sm text-slate-500 dark:text-slate-400 mb-6">
            Your Telegram account is linked. You can chat with your AI assistant and upload receipts directly on Telegram.
          </p>
          <button type="button" (click)="unlinkTelegram()"
            class="inline-flex items-center gap-2 rounded-xl border border-red-200 dark:border-red-800 bg-red-50 dark:bg-red-900/20 px-4 py-2.5 text-sm font-medium text-red-600 dark:text-red-400 transition-all hover:bg-red-100 dark:hover:bg-red-900/30">
            <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round"
                d="M13.181 8.68a4.503 4.503 0 011.903 6.405m-9.768-2.782L3.56 14.06a4.5 4.5 0 006.364 6.365l.164-.163m-2.193-7.378a4.5 4.5 0 016.364 0M12 12h.008v.008H12V12z" />
            </svg>
            Disconnect Telegram
          </button>
        </div>
      } @else {
        <!-- Link Flow -->
        <div class="text-center">
          <!-- Telegram Icon -->
          <div
            class="mx-auto mb-4 flex h-16 w-16 items-center justify-center rounded-2xl bg-sky-100 dark:bg-sky-900/30">
            <svg class="h-8 w-8 text-sky-600 dark:text-sky-400" viewBox="0 0 24 24" fill="currentColor">
              <path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.479.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/>
            </svg>
          </div>

          <h3 class="text-lg font-semibold text-slate-900 dark:text-white mb-2">Connect to Telegram</h3>
          <p class="text-sm text-slate-500 dark:text-slate-400 mb-6">
            Scan the QR code below with Telegram to link your account. You can then chat with your AI assistant and upload receipts directly on Telegram.
          </p>

          @if (telegramLinkLoading()) {
            <!-- Loading state -->
            <div class="flex flex-col items-center gap-3 py-8">
              <div class="h-8 w-8 animate-spin rounded-full border-2 border-sky-500 border-t-transparent"></div>
              <p class="text-sm text-slate-500 dark:text-slate-400">Generating link...</p>
            </div>
          } @else if (telegramLinkError()) {
            <!-- Error state -->
            <div class="rounded-xl border border-red-200 dark:border-red-800 bg-red-50 dark:bg-red-900/20 p-4 mb-4">
              <p class="text-sm text-red-600 dark:text-red-400">{{ telegramLinkError() }}</p>
            </div>
            <button type="button" (click)="openTelegramDialog()"
              class="inline-flex items-center gap-2 rounded-xl bg-sky-600 px-4 py-2.5 text-sm font-medium text-white shadow-lg transition-all hover:bg-sky-700">
              Try Again
            </button>
          } @else if (telegramQrDataUrl()) {
            <!-- QR Code -->
            <div class="flex flex-col items-center gap-4">
              <div class="rounded-2xl border-2 border-slate-200 dark:border-slate-700 bg-white p-3">
                <img [src]="telegramQrDataUrl()" alt="Telegram QR Code" class="h-52 w-52" />
              </div>

              <p class="text-xs text-slate-400 dark:text-slate-500">
                Or tap the link below on mobile:
              </p>

              <a [href]="telegramDeepLink()" target="_blank" rel="noopener noreferrer"
                class="inline-flex items-center gap-2 rounded-xl bg-sky-600 px-5 py-2.5 text-sm font-medium text-white shadow-lg transition-all hover:bg-sky-700 hover:scale-[1.02]">
                <svg class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.479.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/>
                </svg>
                Open in Telegram
              </a>

              <div class="flex items-center gap-2 text-xs text-slate-400 dark:text-slate-500">
                <div class="h-1.5 w-1.5 rounded-full bg-amber-400 animate-pulse"></div>
                Waiting for you to scan...
              </div>
            </div>
          }

          <!-- Features list -->
          <div class="mt-6 pt-6 border-t border-slate-200 dark:border-slate-800">
            <h4 class="text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-3">What you can do on Telegram</h4>
            <div class="grid grid-cols-1 gap-2 text-left">
              <div class="flex items-center gap-2.5">
                <div class="flex h-6 w-6 items-center justify-center rounded-full bg-emerald-100 dark:bg-emerald-900/30">
                  <svg class="h-3 w-3 text-emerald-600 dark:text-emerald-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
                  </svg>
                </div>
                <span class="text-xs text-slate-600 dark:text-slate-400">Chat with your AI financial assistant</span>
              </div>
              <div class="flex items-center gap-2.5">
                <div class="flex h-6 w-6 items-center justify-center rounded-full bg-emerald-100 dark:bg-emerald-900/30">
                  <svg class="h-3 w-3 text-emerald-600 dark:text-emerald-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
                  </svg>
                </div>
                <span class="text-xs text-slate-600 dark:text-slate-400">Send receipt photos to add them instantly</span>
              </div>
              <div class="flex items-center gap-2.5">
                <div class="flex h-6 w-6 items-center justify-center rounded-full bg-emerald-100 dark:bg-emerald-900/30">
                  <svg class="h-3 w-3 text-emerald-600 dark:text-emerald-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
                  </svg>
                </div>
                <span class="text-xs text-slate-600 dark:text-slate-400">Conversations sync with this app</span>
              </div>
            </div>
          </div>
        </div>
      }
    </div>
  </div>
  }
</div>
